<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>vxlan | 我爱西红柿</title>
  <meta name="description" content="什么是vxlan？VXLAN（Virtual Extensible LAN）虚拟可扩展局域网是目前NVO3(Network Virtualization Over Layer 3 基于三层IP  overlay网络构建虚拟网络技术统称NVO3)，它是目前NVO3中影响力最为广泛的一种，它通过L2 over L4 (MAC in UDP)的报文封装方式，实现基于IP overlay的虚拟局域网。
传">
<meta property="og:type" content="article">
<meta property="og:title" content="vxlan">
<meta property="og:url" content="http://yoursite.com/2017/02/24/vxlan/index.html">
<meta property="og:site_name" content="我爱西红柿">
<meta property="og:description" content="什么是vxlan？VXLAN（Virtual Extensible LAN）虚拟可扩展局域网是目前NVO3(Network Virtualization Over Layer 3 基于三层IP  overlay网络构建虚拟网络技术统称NVO3)，它是目前NVO3中影响力最为广泛的一种，它通过L2 over L4 (MAC in UDP)的报文封装方式，实现基于IP overlay的虚拟局域网。
传">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_1.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_2.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_3.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_4.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_5.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_6.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_7.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_8.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_8.1.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_8.2.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_9.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_10.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_11.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_12.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_13.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_14.png">
<meta property="og:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_15.png">
<meta property="og:updated_time" content="2017-02-24T06:24:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="vxlan">
<meta name="twitter:description" content="什么是vxlan？VXLAN（Virtual Extensible LAN）虚拟可扩展局域网是目前NVO3(Network Virtualization Over Layer 3 基于三层IP  overlay网络构建虚拟网络技术统称NVO3)，它是目前NVO3中影响力最为广泛的一种，它通过L2 over L4 (MAC in UDP)的报文封装方式，实现基于IP overlay的虚拟局域网。
传">
<meta name="twitter:image" content="http://ohx02qrb8.bkt.clouddn.com/vxlan_1.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://yoursite.com/2017/02/24/vxlan/index.html">
  
    <link rel="alternate" href="/atom.xml" title="我爱西红柿" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <!-- font-awesome CSS -->
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  
    
    

</head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/wanshaoyuan" target="_blank">
          <img class="img-circle img-rotate" src="/images/image.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">我爱西红柿</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">OpenStack engineer &amp;&amp; devops</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="fa fa-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="fa fa-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      <!-- <span class="ins-close ins-selectable"><i class="fa fa-times"></i></span> -->
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav">
        
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="fa fa-fw fa-dashboard"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="fa fa-fw fa-delicious"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="fa fa-fw fa-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="fa fa-fw fa-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="fa fa-fw fa-gg"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="fa fa-fw fa-coffee"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/wanshaoyuan" target="_blank" title="Github" ><i class="fa fa-github"></i></a></li>
        
        <li><a href="http://www.bldewan.com" target="_blank" title="Behance" ><i class="fa fa-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" ><i class="fa fa-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            
            <div class="content">
                <p>已知的已知，已知的未知，未知的未知</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ceph/">ceph</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/neutron/">neutron</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/openstack/">openstack</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ceph/">ceph</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/neutron/">neutron</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openstack/">openstack</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/安全/">安全</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/操作系统/">操作系统</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Linux/" style="font-size: 13.8px;">Linux</a> <a href="/tags/Python/" style="font-size: 13.2px;">Python</a> <a href="/tags/ceph/" style="font-size: 13.4px;">ceph</a> <a href="/tags/docker/" style="font-size: 14px;">docker</a> <a href="/tags/neutron/" style="font-size: 13.4px;">neutron</a> <a href="/tags/openstack/" style="font-size: 13.6px;">openstack</a> <a href="/tags/安全/" style="font-size: 13px;">安全</a> <a href="/tags/操作系统/" style="font-size: 13px;">操作系统</a> <a href="/tags/数据库/" style="font-size: 13.2px;">数据库</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">6</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/docker/">docker</a>
              </p>
              <p class="item-title">
                <a href="/2017/12/05/docker_compose/" class="title">docker-compose</a>
              </p>
              <p class="item-date">
                <time datetime="2017-12-05T13:45:59.000Z" itemprop="datePublished">2017-12-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/docker/">docker</a>
              </p>
              <p class="item-title">
                <a href="/2017/12/04/docker_habor/" class="title">docker镜像仓库管理软件(habor）</a>
              </p>
              <p class="item-date">
                <time datetime="2017-12-04T13:45:59.000Z" itemprop="datePublished">2017-12-04</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/docker/">docker</a>
              </p>
              <p class="item-title">
                <a href="/2017/12/01/docker-rancher/" class="title">Docker 管理平台(Rancher)</a>
              </p>
              <p class="item-date">
                <time datetime="2017-12-01T13:45:59.000Z" itemprop="datePublished">2017-12-01</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/openstack/">openstack</a>
              </p>
              <p class="item-title">
                <a href="/2017/11/28/openstack_iso/" class="title">openstack使用ISO镜像</a>
              </p>
              <p class="item-date">
                <time datetime="2017-11-28T16:15:26.000Z" itemprop="datePublished">2017-11-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/docker/">docker</a>
              </p>
              <p class="item-title">
                <a href="/2017/11/17/docker_network_overlay/" class="title">Docker多主机网络(overlay)</a>
              </p>
              <p class="item-date">
                <time datetime="2017-11-17T13:45:59.000Z" itemprop="datePublished">2017-11-17</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是vxlan？"><span class="toc-number">1.</span> <span class="toc-text">什么是vxlan？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#传统网络存在的一些问题"><span class="toc-number">2.</span> <span class="toc-text">传统网络存在的一些问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vxlan的提出很好的解决了上述问题"><span class="toc-number">3.</span> <span class="toc-text">vxlan的提出很好的解决了上述问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VXLAN的优点"><span class="toc-number">4.</span> <span class="toc-text">VXLAN的优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#概念"><span class="toc-number">5.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vxlan网关"><span class="toc-number">6.</span> <span class="toc-text">vxlan网关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vxlan实验"><span class="toc-number">7.</span> <span class="toc-text">vxlan实验</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-vxlan" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      vxlan
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="fa fa-calendar-check-o"></i>
	<a href="/2017/02/24/vxlan/" class="article-date">
	  <time datetime="2017-02-24T06:24:44.000Z" itemprop="datePublished">2017-02-24</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/neutron/">neutron</a>
  </span>

        
  <span class="article-tag">
    <i class="fa fa-tag"></i>
	<a class="article-tag-link" href="/tags/neutron/">neutron</a>
  </span>


        

        <span class="post-comment"><i class="fa fa-commenting-o"></i> <a href="/2017/02/24/vxlan/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 3,066(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 12(分)</span>
	

      </div>
      
      <div class="toggle-toc hidden-xs" data-stick-top>
        <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
          <i class="text-collapsed fa fa-anchor"></i>
          <i class="text-in fa fa-close"></i>
        </a>
      </div>
      
    </div>
    <div class="article-entry markdown-body" itemprop="articleBody">
      
        <h3 id="什么是vxlan？"><a href="#什么是vxlan？" class="headerlink" title="什么是vxlan？"></a>什么是vxlan？</h3><p>VXLAN（Virtual Extensible LAN）虚拟可扩展局域网是目前NVO3(Network Virtualization Over Layer 3 基于三层IP  overlay网络构建虚拟网络技术统称NVO3)，它是目前NVO3中影响力最为广泛的一种，它通过L2 over L4 (MAC in UDP)的报文封装方式，实现基于IP overlay的虚拟局域网。</p>
<h3 id="传统网络存在的一些问题"><a href="#传统网络存在的一些问题" class="headerlink" title="传统网络存在的一些问题"></a>传统网络存在的一些问题</h3><p>1，传统的二层网络，交换机通过mac地址进行数据转发，mac地址一多会造成交换机的转发速率变慢，同时交换机的mac地址表的大小是有限制的，在云计算中，mac表容量限制了虚拟机的数量。<br>2，VLAN的vlan id是一个12bit，最大只支持4096个vlan，这在云计算中是远远不够的。</p>
<h3 id="vxlan的提出很好的解决了上述问题"><a href="#vxlan的提出很好的解决了上述问题" class="headerlink" title="vxlan的提出很好的解决了上述问题"></a>vxlan的提出很好的解决了上述问题</h3><p>1，vxlan采用MAC in UDP的方式将vm主机的数据报文封装在UDP中，并使用物理网络VTEP的IP和MAC地址在外层包头封装进行数据传输，对外表现为VTEP之间的mac地址，极大的降低了交换机mac地址使用。  </p>
<p>2，VXLAN报文中拥有一个24bit vni段，vxlan隔离不同租户就是通过vni来进行，一个vni表示一个租户，不同vni之间二层不能直接通信，但可以通过vxlan三层网关进行通信。即使多个终端用户属于同一个vni也属于同一个租户。  </p>
<h3 id="VXLAN的优点"><a href="#VXLAN的优点" class="headerlink" title="VXLAN的优点"></a>VXLAN的优点</h3><p>1，基于ip的overlay网络，仅需要边界VTEP设备间可通信<br>2，ip overlay TTL避免环路。<br>3，overlay+vni构建虚拟网络支持多达16M的虚拟网络，充分满足多租户的需求<br>4，接入交换机只需要学习物理服务器的mac地址，不需要学习每台VM的mac地址减轻了交换机的负担</p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>NVE(Network virtrualization Edge网络虚拟边缘节点）是实现网络虚拟化功能的实体。<br>VTEP(vxlan tunnel end point vxlan 隧道端点）vxlan网络中的NVE以VTEP为标识；每个NVE至少得有一个VTEP；VTEP使用NVE的IP地址表示；两个VTEP之间可以确立一条VXLAN隧道，VTEP间的这条VXLAN隧道将两个NVE之间的所有的VNI所公用。<br>VTEP可以由专有硬件来实现，也可以使用纯软件实现，硬件的实现是通过一些SDN交换机，软件的实现主要有  </p>
<p>1，带vxlan内核模块的Linux<br>2，openvswitch  </p>
<p><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_1.png" alt="">  </p>
<p>vxlan报文格式<br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_2.png" alt="">  </p>
<p>端口默认使用4789端口<br>报文中源IP为报文的虚拟机所属的VTEP的IP地址，目的IP为目的虚拟机所属的VTEP的IP，目标ip地址可以为单播地址也可以为组播地址  </p>
<p>vxlan网络架构图<br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_3.png" alt="">  </p>
<p>vxlan使用 MAC IN UDP的方式来延伸二层网络，是一种扩展大二层网络的隧道封装技术。  </p>
<p>NVE负责将vm的报文封装，建立隧道网络。如服务器上的openvswitch就是一个NVE。   </p>
<p>VXLAN报文的转发<br>一种是BUM(broadcast&amp;unknown-unicast&amp;multicast)报文转发，一种是已知的单播报文转发  </p>
<p>BUM报文转发：采用头端复制的方式(vm上层VTEP接口收到BUM报文后本地VTEP通过控制平面获取同一VNI的VTEP列表，将收到的BUM报文根据VTEP列表进行复制并发送给属于同一VNI的所有VTEP)并进行报文封装。  </p>
<p><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_4.png" alt=""></p>
<p>1，switch_1收到来终端A发出的报文后，提取报文信息，并判断报文的目的MAC地址是否为BUM MAC.<br>     是，在对应的二层广播域内广播，并跳转2。<br>    不是，走已知单播报文转发流程。<br>2，switch_1根据报文中的VNI信息获取同一VNI的VTEP列表获取对应的二层广播域，进行vxlan封装，基于出端口和vxlan封装信息封装vxlan头和外层IP信息，进行二层广播。<br>3，switch_2和switch_3上VTEP收到VXLAN报文后，根据UDP目的端口号、源和目的IP地址VNI判断VXLAN报文的合法有效性，依据VNI获取对应的二层广播域，然后进行VXLAN解封装，获取内层二层报文，判断报文的目的MAC是否为BUM MAC<br>     是，在对应的二层广播域内非VXLAN侧进行广播处理。<br>     不是，再判断是否是本机的MAC地址。<br>           是，本机MAC，上送主机处理。<br>           不是，在对应的二层广播域内查找出接口和封装信息并跳转4.<br>4，switch_2和switch_3根据查找到的出接口和封装信息，为报文添加VLAN tag，转发给对应的终端B/C.   </p>
<p>已知单播报文转发<br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_5.png" alt=""></p>
<p>1，switch_1收到来自终端A的报文，根据报文信息接入端口和VLAN信息获取对应的二层广播域，并判断报文的目的MAC是否为已知的单播MAC<br>       是，在判断是否为本机MAC.<br>               是，上送主机处理。<br>              不是，在对应的二层广播域内查找出接口和封装信息，并跳装到2.  </p>
<p>2， switch_1上VTEP根据查找到的出接口和封装信息进行VXLAN封装和报文转发。<br>3，switch_2上VTEP收到VXLAN报文后，根据UDP目的端口号，源/目的IP地址，VNI判断VXLAN报文的合法有效性，依据VNI获取对应的二层广播域，然后进行VXLAN解封装、获取内层二层报文，判断报文的目的MAC是否为已知单播报文MAC。<br>        是，在对应的二层广播域内查找出接口和封装信息，并跳转到4.<br>        不是，在判断是否是本机的mac。<br>                   是，上送主机处理。<br>                  不是，走BUM报文转发流程。<br>4，switch_2根据查找的出接口和封装信息，为报文添加VLAN tag，转发给对应的终端B。  </p>
<p>为了防止不同vm之间通信发送arp广播引发广播风暴，vtep有一个arp proxy的功能也就是说在请求这个VTEP节点上的虚拟机的mac地址都是由VTEP的mac地址应答。也就是l2population。  </p>
<h3 id="vxlan网关"><a href="#vxlan网关" class="headerlink" title="vxlan网关"></a>vxlan网关</h3><p>vxlan下vm之间的通信方式有3种，同VNI下不同VM，不同VNI下跨网访问，vxlan和非vxlan之间访问。  </p>
<p>vxlan网关分为<br>二层网关、三层网关。<br>二层网关：主要用于解决同VNI下不同VM之间通信，一般为vetp IP<br>三层网关：用于解决不同VNI下跨网访问，和vxlan和非vxlan之间访问。  </p>
<p>通俗理解就是<br>在一台实体服务器上可以虚拟出一个交换机来，这个交换机就是VSwitch，而这个VSwitch下挂的不再是实体服务器，而是一个个VM，一个VM其实就是一个租户租用的服务器，不同租户之间肯定是不能互访的，要不然租户数据的安全性如何保障，这个隔离就是靠的VNI这个ID，其实这个你可以向下VLAN是如何隔离的，目的就是为了隔离租户。我一个租户有2个VM的话，那么我这2个之间应该可以互访吧。所以说基于VNI定义的租户，而非基于VM。内部的结构说清楚了再来说上行如何访问，在一个L2交换机你要跨网访问必然要经过网关，这个网关的IP地址就是VTEP IP，在网络上有个概念叫arp-proxy，一般用途是为了保护内部私有网络，外界的所有应答都有网关来代替回答（可以理解为门卫）。在这里外界只需要你的VTEP IP即可，对端报文到达VTEP这个网关后自己在内部走L2进行转发。因此VXLAN报文中的目的IP就是对端的网关（VTEP IP），而源地址自然也是自己的网关（VTEP IP）。而对于不同leaf上的同一VNI的VM来说，他们的VTEP IP肯定要配置相同，想下同一vlan下的服务器的网关是如何配置的就明白了  </p>
<p><a href="http://www.cnblogs.com/hbgzy/p/5279269.html" target="_blank" rel="external">http://www.cnblogs.com/hbgzy/p/5279269.html</a><br><a href="http://blog.csdn.net/zztflyer/article/details/51883523" target="_blank" rel="external">http://blog.csdn.net/zztflyer/article/details/51883523</a></p>
<h3 id="vxlan实验"><a href="#vxlan实验" class="headerlink" title="vxlan实验"></a>vxlan实验</h3><p>环境<br>操作系统：centos7.2<br>内核版本：3.10<br>openvswitch版本：2.5  </p>
<p><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_6.png" alt=""></p>
<p>在两台虚拟机上安装好ovs，并启动<br>这个实验目的，就是HOST 1的 br1，没有根物理网卡绑定，但可以通过建利vxlan隧道与HOST2的br1通信。  </p>
<p>配置host1<br>创建两个网桥br0、br1<br>ovs-vsctl add-br br0<br>ovs-vsctl add-br br1<br>将eth0挂载到br0上<br>ovs-vsctl add-port br0 eth0</p>
<p>将eth0的ip分配到br0上<br>ifconfig eth0 0 &amp;&amp; ifconfig br0 192.168.1.2/24  </p>
<p>给br1分配一个ip<br>ifconfig br1 192.168.2.2/24  </p>
<p>配置host2<br>创建两个网桥br0、br1<br>ovs-vsctl add-br br0<br>ovs-vsctl add-br br1<br>将eth0挂载到br0上  </p>
<p>ovs-vsctl add-port br0 eth0</p>
<p>将eth0的ip分配到br0上<br>ifconfig eth0 0 &amp;&amp; ifconfig br0 192.168.1.3/24</p>
<p>给br1分配一个ip<br>ifconfig br1 192.168.2.3/24  </p>
<p>此时在hots1上ping host2上的br0的ip是可以通的<br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_7.png" alt=""></p>
<p>ping br1的ip是pint不通的<br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_8.png" alt=""></p>
<p>通过建立vxlan隧道来实现br1之间通信<br>在host1上执行<br>给br1上增加一个vxlan0接口类型为vxlan，远程ip为 host2上的br0 ip， vni为100<br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_8.1.png" alt=""><br>在host2上执行<br>远端ip为host1上br0的ip<br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_8.2.png" alt=""></p>
<p>此时在host1上ping host2的br1的ip  </p>
<p><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_9.png" alt=""><br>就可以ping通了  </p>
<p>在host2上的 eth0上抓包<br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_10.png" alt="">  </p>
<p><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_11.png" alt="">  </p>
<p>有两层报文封装第一层源ip为192.168.2.2 目标ip为192.168.2.3，然后被udp封装，走vxlan隧道，第二层源ip为192.168.1.2 目标ip为192.168.1.3</p>
<p><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_12.png" alt=""><br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_13.png" alt=""></p>
<p>网络包经过 vxlan interface 到达 eth1 的过程中，Linux vxlan 内核模块会将网络包二层帧封装成 UDP 包，因此，vxlan interface 必须设置适当的 MTU 来限制通过它的网络包的大小（vxlan interface 的 MTU 需要比它所绑定的物理网卡的 MTU 小 50），否则，封装后的包会被 eth1 丢弃。</p>
<p>VTEP (vxlan 随道端点）vswitch生成br-tun连接各个节点<br><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_14.png" alt="">  </p>
<p>像这些  </p>
<p>为什么vlan只支持4096个因为vid只有12bit 2的12次方=4096  </p>
<p>为什么用vxlan不用vlan？<br>因为vlan最大只有4096个<br>虚拟化技术的话用vlan运行vm一多，交换机上的mac地址会很多，影响交换机性能。<br>stp算法会产生大量多路路径冗余  </p>
<p>vxlan：建立在物理网络上的虚拟以太网<br>vlxan是一种将二层报文用三层协议进行封装的技术，它进行传输的标识是通过VNI vni包含24bit所以vxlan最大支持2的24次方约16m个，会将二层数据包封装成udp报文通过隧道组播传输，一般配置的组播地址224.0.0.1发送arp，udp端口是4789，共50字节封装报头<br>     UDP校验和：一般为0，非0则此包将会被丢弃。  </p>
<p>数据包都是通过vtep进行封装传输<br>在 OVS 中, 有几个非常重要的概念：  </p>
<p>Bridge: Bridge 代表一个以太网交换机（Switch），一个主机中可以创建一个或者多个 Bridge 设备。  </p>
<p>Port: 端口与物理交换机的端口概念类似，每个 Port 都隶属于一个 Bridge。  </p>
<p>Interface: 连接到 Port 的网络接口设备。在通常情况下，Port 和 Interface 是一对一的关系, 只有在配置 Port 为 bond 模式后，Port 和 Interface 是一对多的关系。  </p>
<p>Controller: OpenFlow 控制器。OVS 可以同时接受一个或者多个 OpenFlow 控制器的管理。  </p>
<p>datapath: 在 OVS 中，datapath 负责执行数据交换，也就是把从接收端口收到的数据包在流表中进行匹配，并执行匹配到的动作。  </p>
<p>Flow table: 每个 datapath 都和一个“flow table”关联，当 datapath 接收到数据之后， OVS 会在<br>flow table 中查找可以匹配的 flow，执行对应的操作, 例如转发数据到另外的端口。  </p>
<p>veth-pair：一对接口，一个接口收另外一个接口同时也能收到，用于连接两个Brigge  </p>
<p>设置网络接口设备的类型为“internal”。对于 internal 类型的的网络接口，OVS 会同时在 Linux 系统中创建一个可以用来收发数据的模拟网络设备。我们可以为这个网络设备配置 IP 地址、进行数据监听等等。  </p>
<p><img src="http://ohx02qrb8.bkt.clouddn.com/vxlan_15.png" alt=""></p>
<p>参考链接<br><a href="http://www.360doc.com/content/16/0227/12/3038654_537760576.shtml" target="_blank" rel="external">http://www.360doc.com/content/16/0227/12/3038654_537760576.shtml</a><br><a href="http://blog.csdn.net/xjtuse2014/article/details/51376123?locationNum=7" target="_blank" rel="external">http://blog.csdn.net/xjtuse2014/article/details/51376123?locationNum=7</a><br><a href="http://www.cnblogs.com/hbgzy/p/5279269.html" target="_blank" rel="external">http://www.cnblogs.com/hbgzy/p/5279269.html</a><br><a href="http://blog.csdn.net/zztflyer/article/details/51883523" target="_blank" rel="external">http://blog.csdn.net/zztflyer/article/details/51883523</a></p>

      
    </div>
    <div class="article-footer">
      
    </div>
  </article>
  
    
  <section id="comments">
  	
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2017/04/17/trove/" title="trove原理"><i class="fa fa-angle-left" aria-hidden="true"></i>&nbsp;&nbsp;上一篇</a>
    </li>
    
    
    <li class="next">
      <a href="/2017/02/09/killo_newton/" title="kolla 3.0.3部署openstack newton">下一篇&nbsp;&nbsp;<i class="fa fa-angle-right" aria-hidden="true"></i></a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
  </div>
  
  </div>
</nav>
  


</main>

  
  <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.js"></script>
<script src="/js/application.js"></script>
  
    
    
    
        <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>
    
    
    
        


    
    
        
    
    



</body>
</html>