<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>eBPF学习摘要2—工具使用(bpftrace） | 我爱西红柿</title>
  <meta name="description" content="概述bpftrace是基于eBPF实现的动态的工具，使用DSL（Domain Specific Language）编写eBPF程序，使用LLVM编译eBPF字节码，BCC与LinuxBPF系统交互。直接使用DSL编写好的脚本（类似awk语言）可以执行，无需在内核中手动编译和加载。bpftrace在内核中实现动态追踪主要是使用Kprobe探针和Tracepoints探针。使用bpftrace可以更深">
<meta property="og:type" content="article">
<meta property="og:title" content="eBPF学习摘要2—工具使用(bpftrace）">
<meta property="og:url" content="http://yoursite.com/2022/09/18/ebpf_2/index.html">
<meta property="og:site_name" content="我爱西红柿">
<meta property="og:description" content="概述bpftrace是基于eBPF实现的动态的工具，使用DSL（Domain Specific Language）编写eBPF程序，使用LLVM编译eBPF字节码，BCC与LinuxBPF系统交互。直接使用DSL编写好的脚本（类似awk语言）可以执行，无需在内核中手动编译和加载。bpftrace在内核中实现动态追踪主要是使用Kprobe探针和Tracepoints探针。使用bpftrace可以更深">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://image-1251900790.cos.ap-chengdu.myqcloud.com/image/ebfp2_2.png">
<meta property="og:image" content="https://image-1251900790.cos.ap-chengdu.myqcloud.com/image/ebfp2_1.png">
<meta property="article:published_time" content="2022-09-18T13:45:59.000Z">
<meta property="article:modified_time" content="2022-09-18T13:45:59.000Z">
<meta property="article:author" content="我爱西红柿">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image-1251900790.cos.ap-chengdu.myqcloud.com/image/ebfp2_2.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://yoursite.com/2022/09/18/ebpf_2/index.html">
  
    <link rel="alternate" href="/atom.xml" title="我爱西红柿" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <!-- font-awesome CSS -->
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
    
    

<meta name="generator" content="Hexo 7.2.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/wanshaoyuan" target="_blank">
          <img class="img-circle img-rotate" src="/images/image.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">我爱西红柿</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Solution Architect</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="fa fa-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="fa fa-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      <!-- <span class="ins-close ins-selectable"><i class="fa fa-times"></i></span> -->
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav">
        
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="fa fa-fw fa-dashboard"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="fa fa-fw fa-delicious"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="fa fa-fw fa-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="fa fa-fw fa-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="fa fa-fw fa-gg"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="fa fa-fw fa-coffee"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/wanshaoyuan" target="_blank" title="Github" ><i class="fa fa-github"></i></a></li>
        
        <li><a href="http://www.bldewan.com" target="_blank" title="Behance" ><i class="fa fa-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" ><i class="fa fa-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            
            <div class="content">
                <p>已知的已知，已知的未知，未知的未知</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CI-CD/">CI/CD</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GPU/">GPU</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ServiceMesh/">ServiceMesh</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a><span class="category-list-count">31</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/openstack/">openstack</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/">分布式存储</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BA%94%E7%94%A8%E4%B8%8A%E4%BA%91/">应用上云</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/" rel="tag">AI</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI-CD/" rel="tag">CI&#x2F;CD</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPU/" rel="tag">GPU</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/" rel="tag">Network</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ServiceMesh/" rel="tag">ServiceMesh</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernete/" rel="tag">kubernete</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a><span class="tag-list-count">30</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openstack/" rel="tag">openstack</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag">分布式存储</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E5%85%A8/" rel="tag">安全</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%94%E7%94%A8%E4%B8%8A%E4%BA%91/" rel="tag">应用上云</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/AI/" style="font-size: 13.11px;">AI</a> <a href="/tags/CI-CD/" style="font-size: 13.67px;">CI/CD</a> <a href="/tags/GPU/" style="font-size: 13px;">GPU</a> <a href="/tags/Linux/" style="font-size: 13.78px;">Linux</a> <a href="/tags/Network/" style="font-size: 13.22px;">Network</a> <a href="/tags/ServiceMesh/" style="font-size: 13.33px;">ServiceMesh</a> <a href="/tags/docker/" style="font-size: 13.89px;">docker</a> <a href="/tags/kubernete/" style="font-size: 13px;">kubernete</a> <a href="/tags/kubernetes/" style="font-size: 14px;">kubernetes</a> <a href="/tags/openstack/" style="font-size: 13.56px;">openstack</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" style="font-size: 13.44px;">分布式存储</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 13.44px;">安全</a> <a href="/tags/%E5%BA%94%E7%94%A8%E4%B8%8A%E4%BA%91/" style="font-size: 13.11px;">应用上云</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 13px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 13.11px;">数据库</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">六月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">6</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/AI/">AI</a>
              </p>
              <p class="item-title">
                <a href="/2024/06/09/mnist_train/" class="title">使用MNIST数据集训练数字识别</a>
              </p>
              <p class="item-date">
                <time datetime="2024-06-09T13:45:59.000Z" itemprop="datePublished">2024-06-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/GPU/">GPU</a>
              </p>
              <p class="item-title">
                <a href="/2023/11/03/gpu-1/" class="title">GPU互联方式</a>
              </p>
              <p class="item-date">
                <time datetime="2023-11-03T13:45:59.000Z" itemprop="datePublished">2023-11-03</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/AI/">AI</a>
              </p>
              <p class="item-title">
                <a href="/2023/10/03/stablediffusion/" class="title">stable diffusion学习系列1（安装部署-Windows环境)</a>
              </p>
              <p class="item-date">
                <time datetime="2023-10-03T13:45:59.000Z" itemprop="datePublished">2023-10-03</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/kubernetes/">kubernetes</a>
              </p>
              <p class="item-title">
                <a href="/2022/12/26/elemental/" class="title">使用DockerFile构建Bare Metal镜像</a>
              </p>
              <p class="item-date">
                <time datetime="2022-12-26T13:45:59.000Z" itemprop="datePublished">2022-12-26</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a>
              </p>
              <p class="item-title">
                <a href="/2022/11/17/spiffe/" class="title">零信任与SPIFFE（一）</a>
              </p>
              <p class="item-date">
                <time datetime="2022-11-17T13:45:59.000Z" itemprop="datePublished">2022-11-17</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">安装和基础使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bpftrace%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">bpftrace执行原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Perf%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">Perf工具使用</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-ebpf_2" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      eBPF学习摘要2—工具使用(bpftrace）
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="fa fa-calendar-check-o"></i>
	<a href="/2022/09/18/ebpf_2/" class="article-date">
	  <time datetime="2022-09-18T13:45:59.000Z" itemprop="datePublished">2022-09-18</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </span>

        
  <span class="article-tag">
    <i class="fa fa-tag"></i>
	<a class="article-tag-link-link" href="/tags/Linux/" rel="tag">Linux</a>
  </span>


        

        <span class="post-comment"><i class="fa fa-commenting-o"></i> <a href="/2022/09/18/ebpf_2/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 3.1k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 15(分)</span>
	

      </div>
      
      <div class="toggle-toc hidden-xs" data-stick-top>
        <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
          <i class="text-collapsed fa fa-anchor"></i>
          <i class="text-in fa fa-close"></i>
        </a>
      </div>
      
    </div>
    <div class="article-entry markdown-body" itemprop="articleBody">
      
        <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a><a href="#%E6%A6%82%E8%BF%B0" title="概述"></a>概述</h3><p>bpftrace是基于eBPF实现的动态的工具，使用DSL（Domain Specific Language）编写eBPF程序，使用LLVM编译eBPF字节码，BCC与LinuxBPF系统交互。直接使用DSL编写好的脚本（类似awk语言）可以执行，无需在内核中手动编译和加载。bpftrace在内核中实现动态追踪主要是使用Kprobe探针和Tracepoints探针。使用bpftrace可以更深入的进行操作系统上问题排查，如某个函数的调用次数和延时、追踪系统OOMKILL、TCP连接丢包等。都可以自定义脚本实现。<br>另外还有一个叫BCC的项目，跟bpftrace区别是BCC可以使用高级语言开发ebfp程序，如Java、Python、Lua……</p>
<p><a href="https://github.com/iovisor/bpftrace">https://github.com/iovisor/bpftrace</a><br><a href="https://github.com/iovisor/bcc">https://github.com/iovisor/bcc</a></p>
<h3 id="安装和基础使用"><a href="#安装和基础使用" class="headerlink" title="安装和基础使用"></a><a href="#%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8" title="安装和基础使用"></a>安装和基础使用</h3><p>系统环境：<br>ubuntu：20.04<br>Kernel：5.4.0-125-generic</p>
<p>参考官网安装方式<br><a href="https://github.com/iovisor/bpftrace/blob/master/INSTALL.md">https://github.com/iovisor/bpftrace/blob/master/INSTALL.md</a><br>有各操作系统发行版的安装方式，也有基于Docker的安装方式<br>我这里为Ubuntu20.04的操作系统，先使用Ubuntu的安装方式进行安装，因为bpftrace依赖ebpf能力，对应不同的内核版本实现的功能有所差异，如4.1 版本实现了kprobes、4.7版本实现了tracepoints官方提供了环境需求检测脚本可以实现对现有环境检测<a href="https://github.com/iovisor/bpftrace/blob/master/scripts/check_kernel_features.sh">https://github.com/iovisor/bpftrace/blob/master/scripts/check_kernel_features.sh</a><br>执行后  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./check_kernel_features.sh</span><br><span class="line"></span><br><span class="line">All required features present!</span><br></pre></td></tr></table></figure>

<p>安装bpftrace  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y bpftrace bpfcc-tools</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>安装完成后查看版本  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bpftrace --version</span><br><span class="line"></span><br><span class="line">bpftrace v0.9.4</span><br></pre></td></tr></table></figure>

<p>列出当前内核支持的Kprobes探针列表  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -l &#x27;kprobe:tcp*</span><br><span class="line"></span><br><span class="line">kprobe:tcp_mmap</span><br><span class="line"></span><br><span class="line">kprobe:tcp_get_info_chrono_stats</span><br><span class="line"></span><br><span class="line">kprobe:tcp_init_sock</span><br><span class="line"></span><br><span class="line">kprobe:tcp_splice_data_recv</span><br><span class="line"></span><br><span class="line">kprobe:tcp_push</span><br><span class="line"></span><br><span class="line">kprobe:tcp_send_mss</span><br><span class="line"></span><br><span class="line">kprobe:tcp_cleanup_rbuf</span><br><span class="line"></span><br><span class="line">kprobe:tcp_set_rcvlowat</span><br><span class="line"></span><br><span class="line">kprobe:tcp_recv_timestamp</span><br><span class="line"></span><br><span class="line">kprobe:tcp_enter_memory_pressure</span><br><span class="line"></span><br><span class="line">kprobe:tcp_leave_memory_pressure</span><br><span class="line"></span><br><span class="line">kprobe:tcp_ioctl</span><br><span class="line"></span><br><span class="line">kprobe:tcp_get_info</span><br><span class="line"></span><br><span class="line">kprobe:tcp_get_md5sig_pool</span><br><span class="line"></span><br><span class="line">kprobe:tcp_set_state</span><br><span class="line"></span><br><span class="line">kprobe:tcp_shutdown</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>内核静态探针-Tracepoint  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -l &#x27;tracepoint:*&#x27;</span><br><span class="line"></span><br><span class="line">kprobe:tcp_mmap</span><br><span class="line"></span><br><span class="line">kprobe:tcp_get_info_chrono_stats</span><br><span class="line"></span><br><span class="line">kprobe:tcp_init_sock</span><br><span class="line"></span><br><span class="line">kprobe:tcp_splice_data_recv</span><br><span class="line"></span><br><span class="line">kprobe:tcp_push</span><br><span class="line"></span><br><span class="line">kprobe:tcp_send_mss</span><br><span class="line"></span><br><span class="line">kprobe:tcp_cleanup_rbuf</span><br><span class="line"></span><br><span class="line">kprobe:tcp_set_rcvlowat</span><br><span class="line"></span><br><span class="line">kprobe:tcp_recv_timestamp</span><br><span class="line"></span><br><span class="line">kprobe:tcp_enter_memory_pressure</span><br><span class="line"></span><br><span class="line">kprobe:tcp_leave_memory_pressure</span><br><span class="line"></span><br><span class="line">kprobe:tcp_ioctl</span><br><span class="line"></span><br><span class="line">kprobe:tcp_get_info</span><br><span class="line"></span><br><span class="line">kprobe:tcp_get_md5sig_pool</span><br><span class="line"></span><br><span class="line">kprobe:tcp_set_state</span><br><span class="line"></span><br><span class="line">kprobe:tcp_shutdown</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_compound</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_compound_status</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_read_start</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_read_splice</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_read_vector</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_read_io_done</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_read_done</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_write_start</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_write_opened</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_write_io_done</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_write_done</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_read_err</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_write_err</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_layoutstate_alloc</span><br><span class="line"></span><br><span class="line">tracepoint:nfsd:nfsd_layoutstate_unhash</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>例如列出所有的进程打开的文件  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">bpftrace -e &#x27;tracepoint:syscalls:sys_enter_openat &#123; printf(&quot;%s %s\n&quot;, comm, str(args-&gt;filename)); &#125;&#x27;</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/memory/kubepods.slice/memory.numa_stat</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/cpu,cpuacct/kubepods.slice/cpu.stat</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/cpu,cpuacct/kubepods.slice/cpuacct.stat</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/cpu,cpuacct/kubepods.slice/cpuacct.usage</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/cpu,cpuacct/kubepods.slice/cpuacct.usage_percpu</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/cpu,cpuacct/kubepods.slice/cpuacct.usage_all</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/pids/kubepods.slice/pids.current</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/pids/kubepods.slice/pids.max</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/blkio/kubepods.slice/blkio.bfq.sectors_recursive</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/blkio/kubepods.slice/blkio.bfq.io_serviced_recur</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/blkio/kubepods.slice/blkio.sectors_recursive</span><br><span class="line"></span><br><span class="line">kubelet /sys/fs/cgroup/blkio/kubepods.slice/blkio.throttle.io_serviced_</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ctrl+c暂停<br>也可以将复杂的命令写成脚本执行，默认安装完后，在&#x2F;usr&#x2F;sbin&#x2F;目录下已经集成了很多脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">ls /usr/sbin/|grep &quot;.*.bt&quot;</span><br><span class="line"></span><br><span class="line">bashreadline.bt</span><br><span class="line"></span><br><span class="line">biolatency.bt</span><br><span class="line"></span><br><span class="line">biosnoop.bt</span><br><span class="line"></span><br><span class="line">biostacks.bt</span><br><span class="line"></span><br><span class="line">bitesize.bt</span><br><span class="line"></span><br><span class="line">capable.bt</span><br><span class="line"></span><br><span class="line">cpuwalk.bt</span><br><span class="line"></span><br><span class="line">dcsnoop.bt</span><br><span class="line"></span><br><span class="line">ebtables</span><br><span class="line"></span><br><span class="line">ebtables-nft</span><br><span class="line"></span><br><span class="line">ebtables-nft-restore</span><br><span class="line"></span><br><span class="line">ebtables-nft-save</span><br><span class="line"></span><br><span class="line">ebtables-restore</span><br><span class="line"></span><br><span class="line">ebtables-save</span><br><span class="line"></span><br><span class="line">execsnoop.bt</span><br><span class="line"></span><br><span class="line">gethostlatency.bt</span><br><span class="line"></span><br><span class="line">killsnoop.bt</span><br><span class="line"></span><br><span class="line">loads.bt</span><br><span class="line"></span><br><span class="line">mdflush.bt</span><br><span class="line"></span><br><span class="line">naptime.bt</span><br><span class="line"></span><br><span class="line">oomkill.bt</span><br><span class="line"></span><br><span class="line">opensnoop.bt</span><br><span class="line"></span><br><span class="line">pidpersec.bt</span><br><span class="line"></span><br><span class="line">runqlat.bt</span><br><span class="line"></span><br><span class="line">runqlen.bt</span><br><span class="line"></span><br><span class="line">setuids.bt</span><br><span class="line"></span><br><span class="line">statsnoop.bt</span><br><span class="line"></span><br><span class="line">swapin.bt</span><br><span class="line"></span><br><span class="line">syncsnoop.bt</span><br><span class="line"></span><br><span class="line">syscount.bt</span><br><span class="line"></span><br><span class="line">tcpaccept.bt</span><br><span class="line"></span><br><span class="line">tcpconnect.bt</span><br><span class="line"></span><br><span class="line">tcpdrop.bt</span><br><span class="line"></span><br><span class="line">tcplife.bt</span><br><span class="line"></span><br><span class="line">tcpretrans.bt</span><br><span class="line"></span><br><span class="line">tcpsynbl.bt</span><br><span class="line"></span><br><span class="line">threadsnoop.bt</span><br><span class="line"></span><br><span class="line">vfscount.bt</span><br><span class="line"></span><br><span class="line">vfsstat.bt</span><br><span class="line"></span><br><span class="line">writeback.bt</span><br><span class="line"></span><br><span class="line">xfsdist.bt</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/iovisor/bpftrace/tree/master/tools">https://github.com/iovisor/bpftrace/tree/master/tools</a> 也存在很多脚本和测试用例。</p>
<p>比如执行tcpconnect.bt 可以参考到本机所有的TCP网络连接  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">tcpconnect.bt </span><br><span class="line"></span><br><span class="line">Attaching 2 probes...</span><br><span class="line"></span><br><span class="line">Tracing tcp connections. Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">TIME     PID      COMM             SADDR                                   SPORT  DADDR                                   DPORT </span><br><span class="line"></span><br><span class="line">23:02:09 1686607  coredns          127.0.0.1                               42216  127.0.0.1                               13429 </span><br><span class="line"></span><br><span class="line">23:02:10 1686607  coredns          127.0.0.1                               42218  127.0.0.1                               13429 </span><br><span class="line"></span><br><span class="line">23:02:11 1680193  kubelet          10.0.1.11                               34732  10.0.1.15                               13429 </span><br><span class="line"></span><br><span class="line">23:02:11 1680193  kubelet          10.0.1.11                               41570  10.0.1.244                              13429 </span><br><span class="line"></span><br><span class="line">23:02:11 1686607  coredns          127.0.0.1                               42224  127.0.0.1                               13429 </span><br><span class="line"></span><br><span class="line">23:02:11 1680193  kubelet          127.0.0.1                               55010  127.0.0.1                               13429 </span><br><span class="line"></span><br><span class="line">23:02:11 1680193  kubelet          10.0.1.11                               33098  10.0.1.145                              13429 </span><br><span class="line"></span><br><span class="line">23:02:12 1686607  coredns          127.0.0.1                               42230  127.0.0.1                               13429 </span><br><span class="line"></span><br><span class="line">23:02:13 1680193  kubelet          127.0.0.1                               34214  127.0.0.1                               13429 </span><br><span class="line"></span><br><span class="line">23:02:13 1686607  coredns          127.0.0.1                               42234  127.0.0.1                               13429</span><br></pre></td></tr></table></figure>

<p>追踪全系统范围内open()调用  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">opensnoop.bt</span><br><span class="line"></span><br><span class="line">Attaching 6 probes...</span><br><span class="line"></span><br><span class="line">Tracing open syscalls... Hit Ctrl-C to end.</span><br><span class="line"></span><br><span class="line">PID    COMM               FD ERR PATH</span><br><span class="line"></span><br><span class="line">1686817 AsyncBlockInput     2   0 /var/lib/clickhouse_storage/store/087/0872950b-6ca9-420e-8872-9</span><br><span class="line"></span><br><span class="line">1686817 AsyncBlockInput     2   0 /var/lib/clickhouse_storage/store/087/0872950b-6ca9-420e-8872-9</span><br><span class="line"></span><br><span class="line">1686817 AsyncBlockInput     2   0 /var/lib/clickhouse_storage/store/435/435debae-6288-4661-835d-e</span><br><span class="line"></span><br><span class="line">1686817 AsyncBlockInput     2   0 /var/lib/clickhouse_storage/store/435/435debae-6288-4661-835d-e</span><br><span class="line"></span><br><span class="line">1686817 AsyncBlockInput     2   0 /var/lib/clickhouse_storage/store/092/09246824-dd69-4f4c-8924-6</span><br><span class="line"></span><br><span class="line">1686817 AsyncBlockInput     2   0 /var/lib/clickhouse_storage/store/092/09246824-dd69-4f4c-8924-6</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br><span class="line"></span><br><span class="line">1680193 kubelet             2   0 /sys/fs/cgroup/memory/kubepods.slice/kubepods-besteffort.slice/</span><br></pre></td></tr></table></figure>
<p>展示最消耗IO的进程及数据写入量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">biotop-bpfcc</span><br><span class="line"></span><br><span class="line">20:53:20 loadavg: 0.96 1.40 1.26 2/2392 3295655</span><br><span class="line"></span><br><span class="line">PID    COMM             D MAJ MIN DISK       I/O  Kbytes  AVGms</span><br><span class="line"></span><br><span class="line">337    jbd2/vda1-8      W 252 0   vda          2   412.0   5.16</span><br><span class="line"></span><br><span class="line">1680139 etcd             W 252 0   vda         14    60.0   2.61</span><br><span class="line"></span><br><span class="line">3295622 rancher-system-  R 252 0   vda          1    56.0   2.07</span><br></pre></td></tr></table></figure>

<p>查看每个进程对应的执行命令和参数  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">execsnoop-bpfcc -T</span><br><span class="line"></span><br><span class="line">TIME     PCOMM            PID    PPID   RET ARGS</span><br><span class="line"></span><br><span class="line">21:22:05 rancher-system-  3310507 1        0 /usr/local/bin/rancher-system-agent sentinel</span><br><span class="line"></span><br><span class="line">21:22:06 cilium-cni       3310516 1680193   0 /opt/cni/bin/cilium-cni</span><br><span class="line"></span><br><span class="line">21:22:06 iptables         3310525 1680164   0 /usr/sbin/iptables -w 5 -W 100000 -S KUBE-PROXY-CANARY -t mangle</span><br><span class="line"></span><br><span class="line">21:22:06 ip6tables        3310524 1680164   0 /usr/sbin/ip6tables -w 5 -W 100000 -S KUBE-PROXY-CANARY -t mangle</span><br><span class="line"></span><br><span class="line">21:22:06 nsenter          3310526 1680193   0 /usr/bin/nsenter --net=/proc/1688099/ns/net -F -- ip -o -4 addr show dev eth0 scope global</span><br><span class="line"></span><br><span class="line">21:22:06 ip               3310526 1680193   0 /usr/sbin/ip -o -4 addr show dev eth0 scope global</span><br><span class="line"></span><br><span class="line">21:22:06 nsenter          3310527 1680193   0 /usr/bin/nsenter --net=/proc/1688099/ns/net -F -- ip -o -6 addr show dev eth0 scope global</span><br><span class="line"></span><br><span class="line">21:22:06 ip               3310527 1680193   0 /usr/sbin/ip -o -6 addr show dev eth0 scope global</span><br><span class="line"></span><br><span class="line">21:22:06 runc             3310528 1679752   0 /usr/bin/runc --version</span><br><span class="line"></span><br><span class="line">21:22:06 docker-init      3310534 1679752   0 /usr/bin/docker-init --version</span><br></pre></td></tr></table></figure>

<p>常用的一些脚本作用</p>
<ul>
<li>killsnoop.bt——追踪 kill() 系统调用发出的信号</li>
<li>tcpconnect.bt——追踪所有的 TCP 网络连接</li>
<li>pidpersec.bt——统计每秒钟（通过fork）创建的新进程</li>
<li>opensnoop.bt——追踪 open() 系统调用</li>
<li>bfsstat.bt——追踪一些 VFS 调用，按秒统计</li>
<li>bashreadline.bt——打印从所有运行shell输入的bash命令</li>
<li>tcplife.bt——追踪TCP连接生命周期</li>
<li>biotop-bpfcc——展示进程io写入</li>
</ul>
<h3 id="bpftrace执行原理"><a href="#bpftrace执行原理" class="headerlink" title="bpftrace执行原理"></a><a href="#bpftrace%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86" title="bpftrace执行原理"></a>bpftrace执行原理</h3><p><img src="https://image-1251900790.cos.ap-chengdu.myqcloud.com/image/ebfp2_2.png"><br>用户态<br>1、用户编写 eBPF 程序，可以使用 eBPF 汇编或者 eBPF 特有的 C 语言来编写。<br>2、使用 LLVM&#x2F;CLang 编译器，将 eBPF 程序编译成 eBPF 字节码。<br>3、调用 bpf() 系统调用把 eBPF 字节码加载到内核。</p>
<p>内核态<br>1、当用户调用 bpf() 系统调用把 eBPF 字节码加载到内核时，内核先会对 eBPF 字节码进行安全验证。<br>2、使用 JIT（Just In Time）技术将 eBPF 字节编译成本地机器码（Native Code）。<br>3、然后根据 eBPF 程序的功能，将 eBPF 机器码挂载到内核的不同运行路径上（如用于跟踪内核运行状态的 eBPF 程序将会挂载在 kprobes 的运行路径上）。当内核运行到这些路径时，就会触发执行相应路径上的 eBPF 机器码。<br>4、通过map与用户空间程序交互</p>
<p>总结<br>通过bpftrace和bcc可以很形象了解ebpf特性，无需修改内核源码和重新编译内核就可以扩展内核的功能，除了像bpftrace这类追踪类软件，还有通过ebfp实现的POD安全威胁检测Falco、基于ebpf负载均衡器Katran等开源产品。另外ebpf_exporter组件也可以将自定义的ebpf执行脚本输出到Prometheus中进行监控。ebpf的生态将越来越丰富。</p>
<h3 id="Perf工具使用"><a href="#Perf工具使用" class="headerlink" title="Perf工具使用"></a><a href="#Perf%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8" title="Perf工具使用"></a>Perf工具使用</h3><p>Perf（Performance Event）是在Linux Kernel2.6集成在Linux Kernel中，主要利用CPU中PMU (Performance Monitoring Unit)和Linux中的 tracepoint实现目标取样和性能分析。Perf工具根eBPF实际上没什么关系，这里写这个工具主要是因为它本身也可以实现应用程序动态追踪，也利用到了tracepoint的能力，但与eBPF不同的是Perf是写死的能力，bpftrace基于eBPF是可以实现脚本灵活的穿插和调用。</p>
<p>安装部署<br>这里使用的操作系统是Ubuntu20.04。Kernel为5.4.0-125-generic</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install linux-tools-common linux-tools-&quot;``(uname -r)&quot; linux-cloud-tools-&quot;``(uname -r)&quot; linux-tools-generic linux-cloud-tools-generic</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>验证版本  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">perf -v</span><br><span class="line"></span><br><span class="line">perf version 5.4.195</span><br></pre></td></tr></table></figure>
<p>采样事件  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">perf list</span><br><span class="line"></span><br><span class="line">List of pre-defined events (to be used in -e):</span><br><span class="line"></span><br><span class="line">  alignment-faults                                   [Software event]</span><br><span class="line"></span><br><span class="line">  bpf-output                                         [Software event]</span><br><span class="line"></span><br><span class="line">  context-switches OR cs                             [Software event]</span><br><span class="line"></span><br><span class="line">  cpu-clock                                          [Software event]</span><br><span class="line"></span><br><span class="line">  cpu-migrations OR migrations                       [Software event]</span><br><span class="line"></span><br><span class="line">  dummy                                              [Software event]</span><br><span class="line"></span><br><span class="line">  emulation-faults                                   [Software event]</span><br><span class="line"></span><br><span class="line">  major-faults                                       [Software event]</span><br><span class="line"></span><br><span class="line">  minor-faults                                       [Software event]</span><br><span class="line"></span><br><span class="line">  page-faults OR faults                              [Software event]</span><br><span class="line"></span><br><span class="line">  task-clock                                         [Software event]</span><br><span class="line"></span><br><span class="line">  duration_time                                      [Tool event]</span><br><span class="line"></span><br><span class="line">  msr/tsc/                                           [Kernel PMU event]</span><br><span class="line"></span><br><span class="line">  rNNN                                               [Raw hardware event descriptor]</span><br><span class="line"></span><br><span class="line">  cpu/t1=v1[,t2=v2,t3 ...]/modifier                  [Raw hardware event descriptor]</span><br><span class="line"></span><br><span class="line">   (see &#x27;man perf-list&#x27; on how to encode it)</span><br><span class="line"></span><br><span class="line">  mem:&lt;addr&gt;[/len][:access]                          [Hardware breakpoint]</span><br><span class="line"></span><br><span class="line">  alarmtimer:alarmtimer_cancel                       [Tracepoint event]</span><br><span class="line"></span><br><span class="line">  alarmtimer:alarmtimer_fired                        [Tracepoint event]</span><br><span class="line"></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>主要分为三类：<br>Hardware Event ：通过PMU获取的硬件CPU的事件，如：cpu-cycles、缓存命中等。<br>Software Event ：软件本身的进程切换和页命中等<br>Tracepoint event：io命中率、文件系统写入速率等</p>
<p>perf top展示各个进程和函数资源占用情况，-g显示子进程，按e显示子进程函数  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">perf top -g </span><br><span class="line"></span><br><span class="line">Samples: 284K of event &#x27;cpu-clock:pppH&#x27;, 4000 Hz, Event count (approx.): 33836570425 lost: 0/0 drop: 0/0</span><br><span class="line"></span><br><span class="line">  Children      Self  Shared Object                                          Symbol</span><br><span class="line"></span><br><span class="line">-   20.27%     0.09%  perf                                                   [.] __ordered_events__flush.part.0                                                            ◆</span><br><span class="line"></span><br><span class="line">   - 2.20% __ordered_events__flush.part.0                                                                                                                                  ▒</span><br><span class="line"></span><br><span class="line">      - 2.56% deliver_event                                                                                                                                                ▒</span><br><span class="line"></span><br><span class="line">         - 3.39% hist_entry_iter__add                                                                                                                                      ▒</span><br><span class="line"></span><br><span class="line">            - 3.79% iter_add_next_cumulative_entry                                                                                                                         ▒</span><br><span class="line"></span><br><span class="line">               - 3.03% __hists__add_entry.constprop.0                                                                                                                      ▒</span><br><span class="line"></span><br><span class="line">                    3.79% hists__findnew_entry                                                                                                                             ▒</span><br><span class="line"></span><br><span class="line">               - 1.54% callchain_append                                                                                                                                    ▒</span><br><span class="line"></span><br><span class="line">                  - 2.64% append_chain_children                                                                                                                            ▒</span><br><span class="line"></span><br><span class="line">                     - 2.22% append_chain_children                                                                                                                         ▒</span><br><span class="line"></span><br><span class="line">                        - 1.73% append_chain_children                                                                                                                      ▒</span><br><span class="line"></span><br><span class="line">                           - 1.34% append_chain_children                                                                                                                   ▒</span><br><span class="line"></span><br><span class="line">                                1.07% append_chain_children                                                                                                                ▒</span><br><span class="line"></span><br><span class="line">+   20.13%     0.18%  perf                                                   [.] deliver_event                                                                             ▒</span><br><span class="line"></span><br><span class="line">+   18.62%     0.04%  perf                                                   [.] hist_entry_iter__add                                                                      ▒</span><br><span class="line"></span><br><span class="line">+   14.47%     0.80%  perf                                                   [.] iter_add_next_cumulative_entry                                                            ▒</span><br><span class="line"></span><br><span class="line">+   12.05%     0.96%  [kernel]                                               [k] do_syscall_64                                                                             ▒</span><br><span class="line"></span><br><span class="line">+    8.99%     0.00%  perf                                                   [.] process_thread                                                                            ▒</span><br><span class="line"></span><br><span class="line">+    8.93%     0.22%  [kernel]                                               [k] do_idle                                                                                   ▒</span><br><span class="line"></span><br><span class="line">+    8.83%     1.06%  [kernel]                                               [k] __softirqentry_text_start                                                                 ▒</span><br><span class="line"></span><br><span class="line">+    8.24%     6.28%  perf                                                   [.] append_chain_children                                                                     ▒</span><br><span class="line"></span><br><span class="line">+    7.11%     0.06%  perf                                                   [.] callchain_append                                                                          ▒</span><br><span class="line"></span><br><span class="line">+    5.96%     4.75%  libc-2.31.so                                           [.] pthread_attr_setschedparam                                                                ▒</span><br><span class="line"></span><br><span class="line">+    5.74%     0.25%  perf                                                   [.] __hists__add_entry.constprop.0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[.]：表示运行在用户态空间<br>[k]：表示运行在内核态空间</p>
<p>perf state查看程序运行情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">perf stat -p 1679752   按ctrl+c输出结果</span><br><span class="line"></span><br><span class="line"> Performance counter stats for process id &#x27;1679752&#x27;:</span><br><span class="line"></span><br><span class="line">            682.90 msec task-clock                #    0.066 CPUs utilized          </span><br><span class="line"></span><br><span class="line">              3154      context-switches          #    0.005 M/sec                  </span><br><span class="line"></span><br><span class="line">                36      cpu-migrations            #    0.053 K/sec                  </span><br><span class="line"></span><br><span class="line">              3275      page-faults               #    0.005 M/sec                  </span><br><span class="line"></span><br><span class="line">   &lt;not supported&gt;      cycles                                                      </span><br><span class="line"></span><br><span class="line">   &lt;not supported&gt;      instructions                                                </span><br><span class="line"></span><br><span class="line">   &lt;not supported&gt;      branches                                                    </span><br><span class="line"></span><br><span class="line">   &lt;not supported&gt;      branch-misses</span><br></pre></td></tr></table></figure>

<p>Task-clock：CPU 利用率<br>Context-switches：进程切换次数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Samples: 1K of event &#x27;block:block_rq_issue&#x27;, 1 Hz, Event count (approx.): 136 lost: 0/0 drop: 0/0</span><br><span class="line"></span><br><span class="line">  Children      Self  Trace output</span><br><span class="line"></span><br><span class="line">+   16.91%    16.91%  252,0 FF 0 () 0 + 0 [kworker/0:1H]</span><br><span class="line"></span><br><span class="line">+   15.44%    15.44%  252,0 FF 0 () 0 + 0 [kworker/7:1H]</span><br><span class="line"></span><br><span class="line">+    9.56%     9.56%  252,0 FF 0 () 0 + 0 [kworker/3:1H]</span><br><span class="line"></span><br><span class="line">+    8.09%     8.09%  252,0 FF 0 () 0 + 0 [kworker/4:1H]</span><br><span class="line"></span><br><span class="line">+    6.62%     6.62%  252,0 WS 4096 () 18340064 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">+    6.62%     6.62%  252,0 WS 4096 () 18340072 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">+    5.15%     5.15%  252,0 FF 0 () 0 + 0 [kworker/2:1H]</span><br><span class="line"></span><br><span class="line">+    4.41%     4.41%  252,0 FF 0 () 0 + 0 [kworker/6:1H]</span><br><span class="line"></span><br><span class="line">+    2.94%     2.94%  252,0 WS 4096 () 122005280 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">     2.21%     2.21%  252,0 WS 4096 () 115952144 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">     2.21%     2.21%  252,0 WS 4096 () 122005272 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">+    1.47%     1.47%  252,0 FF 0 () 0 + 0 [kworker/1:1H]</span><br><span class="line"></span><br><span class="line">+    1.47%     1.47%  252,0 WS 4096 () 116164552 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">     1.47%     1.47%  252,0 WS 4096 () 116173824 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">+    1.47%     1.47%  252,0 WS 4096 () 122005256 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">     1.47%     1.47%  252,0 WS 4096 () 122005288 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">     1.47%     1.47%  252,0 WS 4096 () 122005296 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">     0.74%     0.74%  252,0 FF 0 () 0 + 0 [kworker/5:1H]</span><br><span class="line"></span><br><span class="line">     0.74%     0.74%  252,0 WS 516096 () 2388520 + 1008 [jbd2/vda1-8]</span><br><span class="line"></span><br><span class="line">     0.74%     0.74%  252,0 WS 372736 () 2389528 + 728 [jbd2/vda1-8]</span><br><span class="line"></span><br><span class="line">     0.74%     0.74%  252,0 WS 4096 () 115700160 + 8 [etcd]</span><br><span class="line"></span><br><span class="line">     0.74%     0.74%  252,0 WS 4096 () 115948608 + 8 [etcd]</span><br></pre></td></tr></table></figure>
<p>对CPU事件进行检测，采样时间60s，每秒采样99个事件，采样完成后会在本地生成个perf.data文件，如果执行多次，会将上一个重命名为perf.data.old。加-p可以指定进程号输出。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">perf record -F 99 -a -g -- sleep 60</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>查看报告  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf report</span><br></pre></td></tr></table></figure>
<p>生成火焰图  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">下载制作火焰图工具</span><br><span class="line"></span><br><span class="line">git clone https://github.com/brendangregg/FlameGraph.git</span><br><span class="line"></span><br><span class="line">对perf.data进行解析</span><br><span class="line"></span><br><span class="line">perf script -i perf.data &amp;&gt; perf.unfold</span><br><span class="line"></span><br><span class="line">进行符号处理</span><br><span class="line"></span><br><span class="line">FlameGraph/stackcollapse-perf.pl perf.unfold &amp;&gt; perf.folded</span><br><span class="line"></span><br><span class="line">生成火焰图</span><br><span class="line"></span><br><span class="line">FlameGraph/flamegraph.pl perf.folded &gt; perf.svg</span><br></pre></td></tr></table></figure>
<p>使用chrome浏览器打开<br><img src="https://image-1251900790.cos.ap-chengdu.myqcloud.com/image/ebfp2_1.png"></p>
<p>火焰图怎么查看分析可参考<br><a href="https://www.infoq.cn/article/a8kmnxdhbwmzxzsytlga">https://www.infoq.cn/article/a8kmnxdhbwmzxzsytlga</a></p>
<p>参考链接<br><a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md">https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md</a><br><a href="http://blog.nsfocus.net/bpftrace-dynamic-tracing-0828/">http://blog.nsfocus.net/bpftrace-dynamic-tracing-0828/</a><br><a href="https://www.cnblogs.com/arnoldlu/p/6241297.html">https://www.cnblogs.com/arnoldlu/p/6241297.html</a><br><a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/monitoring_and_managing_system_status_and_performance/counting-events-during-process-execution-with-perf-stat_monitoring-and-managing-system-status-and-performance">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux&#x2F;8&#x2F;html&#x2F;monitoring_and_managing_system_status_and_performance&#x2F;counting-events-during-process-execution-with-perf-stat_monitoring-and-managing-system-status-and-performance</a></p>

      
    </div>
    <div class="article-footer">
      
    </div>
  </article>
  
    
  <section id="comments">
  	
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2022/10/17/ebpf_3/" title="eBPF学习摘要3-XDP学习和理解"><i class="fa fa-angle-left" aria-hidden="true"></i>&nbsp;&nbsp;上一篇</a>
    </li>
    
    
    <li class="next">
      <a href="/2022/08/23/ebpf_1/" title="eBPF学习摘要1(概述、理论)">下一篇&nbsp;&nbsp;<i class="fa fa-angle-right" aria-hidden="true"></i></a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
  </div>
  
  </div>
</nav>
  


</main>

  
  <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.js"></script>


<script src="/js/application.js"></script>

  
    
    
    
        <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>

    
    
    
        


    
    
        
    
    



</body>
</html>